<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>qgtools</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-dfb324f25d9b1687192fa8be62ac8f9c.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">qgtools</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./examples/index.qmd"> 
<span class="menu-text">Examples</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/psoerensen/qgtools"> 
<span class="menu-text">GitHub</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#core-ideas-and-orthogonal-layers" id="toc-core-ideas-and-orthogonal-layers" class="nav-link" data-scroll-target="#core-ideas-and-orthogonal-layers">Core ideas and orthogonal layers</a></li>
  <li><a href="#kernel-and-feature-objects-are-lightweight-descriptors" id="toc-kernel-and-feature-objects-are-lightweight-descriptors" class="nav-link" data-scroll-target="#kernel-and-feature-objects-are-lightweight-descriptors">Kernel and feature objects are lightweight descriptors</a></li>
  <li><a href="#simple-example-to-illustrate-the-concept" id="toc-simple-example-to-illustrate-the-concept" class="nav-link" data-scroll-target="#simple-example-to-illustrate-the-concept">Simple example to illustrate the concept</a></li>
  <li><a href="#model-validation-and-interoperability" id="toc-model-validation-and-interoperability" class="nav-link" data-scroll-target="#model-validation-and-interoperability">Model validation and interoperability</a>
  <ul class="collapse">
  <li><a href="#residual-effects" id="toc-residual-effects" class="nav-link" data-scroll-target="#residual-effects">Residual effects</a></li>
  </ul></li>
  <li><a href="#performance-and-deployment" id="toc-performance-and-deployment" class="nav-link" data-scroll-target="#performance-and-deployment">Performance and deployment</a></li>
  <li><a href="#r-and-python-interfaces" id="toc-r-and-python-interfaces" class="nav-link" data-scroll-target="#r-and-python-interfaces">R and Python interfaces</a></li>
  <li><a href="#data-input-and-preparation" id="toc-data-input-and-preparation" class="nav-link" data-scroll-target="#data-input-and-preparation">Data input and preparation</a>
  <ul class="collapse">
  <li><a href="#standard-data-responses-and-covariates" id="toc-standard-data-responses-and-covariates" class="nav-link" data-scroll-target="#standard-data-responses-and-covariates">Standard data: responses and covariates</a></li>
  <li><a href="#structural-data-kernels" id="toc-structural-data-kernels" class="nav-link" data-scroll-target="#structural-data-kernels">Structural data: kernels</a></li>
  <li><a href="#high-dimensional-predictors-feature-matrices" id="toc-high-dimensional-predictors-feature-matrices" class="nav-link" data-scroll-target="#high-dimensional-predictors-feature-matrices">High-dimensional predictors: feature matrices</a></li>
  </ul></li>
  <li><a href="#annotated-example-multivariate-mixed-bayesian-genomic-model" id="toc-annotated-example-multivariate-mixed-bayesian-genomic-model" class="nav-link" data-scroll-target="#annotated-example-multivariate-mixed-bayesian-genomic-model">Annotated example: Multivariate mixed / Bayesian genomic model</a></li>
  <li><a href="#classical-quantitative-genetics-case-studies-dmu-examples" id="toc-classical-quantitative-genetics-case-studies-dmu-examples" class="nav-link" data-scroll-target="#classical-quantitative-genetics-case-studies-dmu-examples">Classical quantitative genetics case studies (DMU examples)</a>
  <ul class="collapse">
  <li><a href="#dmu-based-examples" id="toc-dmu-based-examples" class="nav-link" data-scroll-target="#dmu-based-examples">DMU-based examples</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">qgtools</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p><strong>qgtools</strong> is a framework for specifying and fitting mixed and hierarchical models, with a focus on quantitative genetics, high-dimensional predictors, and complex covariance structures.</p>
<p>The key idea behind qgtools is to <strong>separate model specification from model fitting</strong>, allowing the same model to be estimated using different software backends and estimation paradigms within a unified modeling framework.</p>
</section>
<section id="core-ideas-and-orthogonal-layers" class="level2">
<h2 class="anchored" data-anchor-id="core-ideas-and-orthogonal-layers">Core ideas and orthogonal layers</h2>
<p>qgtools separates model specification into independent, orthogonal layers.<br>
Each layer answers a distinct modeling question and can be modified without affecting the others.</p>
<ol type="1">
<li><p><strong>Formulas — <em>what</em> enters the model</strong><br>
Per-trait formulas define responses, fixed effects, and named random or latent effects<br>
(e.g.&nbsp;<code>(1 | id)</code>, <code>(1 | marker)</code>).<br>
Formulas describe <em>which</em> effects exist, but not how their covariance is modeled.</p></li>
<li><p><strong>Kernels and features — <em>how</em> effects act on the data</strong><br>
qgtools supports two complementary mechanisms:</p>
<ul>
<li><strong>Kernels</strong> define <em>implicit</em> covariance structures across individuals or traits<br>
(e.g.&nbsp;pedigree, GRM, spatial or temporal correlation).</li>
<li><strong>Feature matrices</strong> define <em>explicit</em> linear predictors with potentially very large numbers of coefficients (e.g.&nbsp;genotypes, transcriptomics, other omics layers).</li>
</ul>
<p>Both kernels and features are reusable, standalone objects that can be shared across models and estimation tasks.</p></li>
<li><p><strong>Variance components or priors — <em>how much</em> variation is attributed</strong><br>
Each effect is paired with either:</p>
<ul>
<li>variance components (<code>vc()</code>) for REML or solver-based estimation, or<br>
</li>
<li>prior distributions (<code>prior()</code>) for Bayesian inference.</li>
</ul>
<p>For feature-based effects, optional <code>featureSets</code> allow effects to be decomposed into multiple components with separate variance parameters.</p></li>
<li><p><strong>Task — <em>how</em> the model is fitted</strong><br>
Estimation is controlled by <code>gfit()</code> via <code>task = "reml"</code>, <code>"solve"</code>, or <code>"bayes"</code>, without changing the model structure.</p></li>
<li><p><strong>Data — <em>where</em> the information comes from</strong><br>
Data are treated as abstract data sources, enabling transparent use of in-memory or disk-backed datasets (e.g.&nbsp;PLINK files, HDF5 matrices).</p></li>
</ol>
<p>All layers are specified independently and validated jointly at fit time.</p>
</section>
<section id="kernel-and-feature-objects-are-lightweight-descriptors" class="level2">
<h2 class="anchored" data-anchor-id="kernel-and-feature-objects-are-lightweight-descriptors">Kernel and feature objects are lightweight descriptors</h2>
<p>Kernel and feature objects in <strong>qgtools</strong> are designed as <em>lightweight descriptors</em> rather than containers of explicit model matrices or parameters. In particular, they do <strong>not</strong> store large covariance matrices or design matrices in memory by default.</p>
<p>Instead, these objects describe <strong>how model components should be constructed or accessed</strong> by downstream computational backends:</p>
<ul>
<li><p><strong>Kernel objects</strong> specify how covariance should be induced across levels of an effect<br>
(e.g.&nbsp;from pedigree information, precomputed relationship matrices, or other structured sources).</p></li>
<li><p><strong>Feature objects</strong> specify how high-dimensional predictors enter the model<br>
(e.g.&nbsp;genotype matrices, transcriptomic measurements, or other omics features),<br>
potentially stored on disk and accessed in a streaming or block-wise fashion.</p></li>
</ul>
<p>Depending on the estimation task and backend, covariance and linear predictors may be:</p>
<ul>
<li>derived implicitly from pedigree or relationship information,</li>
<li>computed on the fly from feature matrices without forming explicit covariance matrices, or</li>
<li>accessed from precomputed objects supplied by the user.</li>
</ul>
<p>This abstraction decouples <strong>statistical model specification</strong> from <strong>data representation and numerical implementation</strong>. As a result, the same model formulation and user-facing code can be applied seamlessly across a wide range of data scales—from small illustrative examples to very large genomic or multi-omics datasets—without modification.</p>
<p>By deferring matrix construction and data access to backend-specific implementations, <strong>qgtools</strong> achieves both flexibility and scalability while preserving a clear and consistent statistical interface.</p>
<ul>
<li><strong>Variance components vs priors</strong><br>
Classical mixed models associate kernels or features with variance components (<code>vc()</code>),<br>
while Bayesian models replace these with explicit prior distributions (<code>prior()</code>),<br>
without changing formulas, kernels, or feature definitions.</li>
</ul>
</section>
<section id="simple-example-to-illustrate-the-concept" class="level2">
<h2 class="anchored" data-anchor-id="simple-example-to-illustrate-the-concept">Simple example to illustrate the concept</h2>
<p>The following example shows a minimal linear mixed model and illustrates how qgtools separates <strong>data input</strong>, <strong>model structure</strong>, <strong>covariance specification</strong>, and <strong>estimation</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ---------------------------------------------------------------</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Data input</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="do">## ---------------------------------------------------------------</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Observational data provide phenotypes and covariates referenced</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="do">## in the model formulas.</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">makeDatalist</span>(</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">source =</span> <span class="st">"data.txt"</span>,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">format =</span> <span class="st">"CSV"</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="do">## ---------------------------------------------------------------</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="do">## Model structure (formulas)</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="do">## ---------------------------------------------------------------</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="do">## Formulas define which effects enter the model,</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="do">## but not how covariance is modeled.</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>formulas <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">BW =</span> BW <span class="sc">~</span> sex <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> id)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="do">## ---------------------------------------------------------------</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="do">## Covariance specification (kernels + variance components)</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="do">## ---------------------------------------------------------------</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="do">## The pedigree kernel defines how covariance is induced</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="do">## across levels of the 'id' effect.</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>PED <span class="ot">&lt;-</span> <span class="fu">makePEDlist</span>(<span class="at">fnPED =</span> <span class="st">"pedigree.txt"</span>)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>vcs <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">animal =</span> <span class="fu">vc</span>(</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">variable =</span> <span class="st">"id"</span>,</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">traits   =</span> <span class="st">"BW"</span>,</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">kernel   =</span> PED</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">residual =</span> <span class="fu">vc</span>(</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">variable =</span> <span class="st">"residual"</span>,</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">traits   =</span> <span class="st">"BW"</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="do">## ---------------------------------------------------------------</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="do">## Model fitting</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="do">## ---------------------------------------------------------------</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a><span class="do">## The estimation task determines how the model is fit,</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="do">## without changing the model structure.</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">gfit</span>(</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">formulas =</span> formulas,</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>  <span class="at">data     =</span> data,</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>  <span class="at">vc       =</span> vcs,</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>  <span class="at">task     =</span> <span class="st">"reml"</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The same model structure can be estimated as a Bayesian model by replacing <em>vc()</em> with <em>prior()</em> and setting <em>task=“bayes”</em>, without changing the formulas, kernels or data.</p>
</section>
<section id="model-validation-and-interoperability" class="level2">
<h2 class="anchored" data-anchor-id="model-validation-and-interoperability">Model validation and interoperability</h2>
<p>Before fitting, qgtools validates the full model bundle (data, formulas, kernels or features, and variance components or priors) to ensure internal consistency.</p>
<p>This validation step checks, for example, that: - all variables referenced in formulas are defined, - kernels or feature matrices are compatible with the corresponding effects, - trait dimensions are consistent across components, and - required variance components or priors are supplied.</p>
<p>Model specifications can also be exported as structured JSON, allowing the same model to be executed by external backends, workflow engines, or non-R/Python environments.</p>
<section id="residual-effects" class="level3">
<h3 class="anchored" data-anchor-id="residual-effects">Residual effects</h3>
<p>The residual variance is represented by a component with <code>variable = "residual"</code>.</p>
<ul>
<li>The residual effect is <strong>implicit</strong> in model formulas and must <strong>not</strong> appear as <code>(1 | residual)</code></li>
<li>It must be explicitly specified using <code>vc()</code> (REML / solver) or <code>prior()</code> (Bayesian)</li>
<li>Residual components never require a kernel or features</li>
</ul>
</section>
</section>
<section id="performance-and-deployment" class="level2">
<h2 class="anchored" data-anchor-id="performance-and-deployment">Performance and deployment</h2>
<p>qgtools is designed as a lightweight R (or Python) interface to high-performance computational backends. Computationally intensive components—such as likelihood evaluation, large-scale linear algebra, and sampling—are implemented in compiled languages such as <strong>C++ or Fortran</strong>, while R (or Python) is used for model specification and orchestration.</p>
<p>This separation provides: - high computational performance, - scalability to large datasets, and - a clear boundary between model definition and numerical implementation.</p>
<p>By representing kernels and feature matrices as <em>lightweight descriptors</em>, qgtools avoids unnecessary memory usage and allows backends to construct covariance structures and linear predictors only when needed, using in-memory or disk-backed data as appropriate.</p>
<p>For deployment, qgtools can be packaged into <strong>containerized environments</strong> (e.g.&nbsp;Docker or Singularity), allowing models to be executed reproducibly on high-performance computing platforms and cloud infrastructures such as <strong>AWS</strong> and <strong>Azure</strong>. Containers bundle the required libraries and runtimes and can be deployed on HPC batch systems or cloud services without exposing source code.</p>
<p>This design enables qgtools to act as a unifying modeling layer while supporting multiple computational backends and deployment scenarios, from local workstations to large-scale cloud and HPC environments.</p>
<p><strong>qgtools</strong> handles large-scale data by taking advantage of:</p>
<ul>
<li>multi-core processing using <a href="https://www.openmp.org/">openMP</a></li>
<li>multithreaded matrix operations implemented in BLAS libraries (e.g.&nbsp;<a href="https://www.openblas.net/">OpenBLAS</a>, <a href="https://math-atlas.sourceforge.net/">ATLAS</a>, or <a href="https://en.wikipedia.org/wiki/Math_Kernel_Library">MKL</a>)</li>
<li>fast and memory-efficient batch processing of feature data stored on disk (e.g.&nbsp;genotype data in <a href="https://www.cog-genomics.org/plink2">PLINK</a> bedfiles)</li>
</ul>
</section>
<section id="r-and-python-interfaces" class="level2">
<h2 class="anchored" data-anchor-id="r-and-python-interfaces">R and Python interfaces</h2>
<p>qgtools is designed with a <strong>language-agnostic core</strong>, allowing both <strong>R and Python</strong> interfaces to interact with the same underlying computational backends.</p>
<p>Model specification and orchestration can be performed in either R or Python, while computationally intensive tasks (e.g.&nbsp;likelihood evaluation, large-scale linear algebra, sampling) are handled by shared C++/Fortran libraries.<br>
This design ensures consistent results across interfaces and enables flexible deployment in cloud and HPC environments.</p>
<p>The example below shows the <em>same mixed model</em> specified in R and Python.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ---------------------------------------------------------------</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="do">## R interface</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="do">## ---------------------------------------------------------------</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Model structure and covariance specification are expressed</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="do">## using the same abstractions as in previous examples.</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>formulas <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">BW =</span> BW <span class="sc">~</span> sex <span class="sc">+</span> reps <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> id)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>vcs <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">animal =</span> <span class="fu">vc</span>(</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">variable =</span> <span class="st">"id"</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">traits   =</span> <span class="st">"BW"</span>,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">kernel   =</span> PED</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">residual =</span> <span class="fu">vc</span>(</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">variable =</span> <span class="st">"residual"</span>,</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">traits   =</span> <span class="st">"BW"</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">gfit</span>(formulas, data, vcs, <span class="at">task =</span> <span class="st">"reml"</span>)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Python interface</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="co"># The same model specification expressed using Python syntax.</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="co"># The underlying model and backend execution are identical.</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>model <span class="ot">=</span> <span class="fu">Model</span>(</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">formulas=</span>{</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">"BW"</span><span class="sc">:</span> <span class="st">"BW ~ sex + reps + (1 | id)"</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">vcs=</span>[</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>        <span class="fu">vc</span>(<span class="at">variable=</span><span class="st">"id"</span>, <span class="at">traits=</span>[<span class="st">"BW"</span>], <span class="at">kernel=</span>PED),</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>        <span class="fu">vc</span>(<span class="at">variable=</span><span class="st">"residual"</span>, <span class="at">traits=</span>[<span class="st">"BW"</span>])</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">=</span> <span class="fu">gfit</span>(model, data, <span class="at">task=</span><span class="st">"reml"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Both interfaces construct the same internal model representation and invoke the same computational backend. Differences between R and Python are limited to syntax and user-facing language conventions.</p>
</section>
<section id="data-input-and-preparation" class="level2">
<h2 class="anchored" data-anchor-id="data-input-and-preparation">Data input and preparation</h2>
<p>qgtools distinguishes between three broad classes of input data: standard observational data, structural data used to define covariance, and high-dimensional feature data. These inputs are prepared independently and combined later during model specification.</p>
<section id="standard-data-responses-and-covariates" class="level3">
<h3 class="anchored" data-anchor-id="standard-data-responses-and-covariates">Standard data: responses and covariates</h3>
<p>Standard data include phenotypes, covariates, and other observed variables referenced directly in model formulas.</p>
<p>Data may be provided either as an in-memory object or as a disk-backed source.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Observational data (phenotypes and covariates)</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">makeDatalist</span>(</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">source =</span> <span class="st">"data.txt"</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">format =</span> <span class="st">"CSV"</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="structural-data-kernels" class="level3">
<h3 class="anchored" data-anchor-id="structural-data-kernels">Structural data: kernels</h3>
<p>Kernels describe how covariance is induced across levels of a model component. They are typically used for low-dimensional random effects, such as pedigree- based genetic effects.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Pedigree-based kernel for additive genetic effects</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>PED <span class="ot">&lt;-</span> <span class="fu">makePEDlist</span>(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">fnPED  =</span> <span class="st">"pedigree.txt"</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"S-D-NonInbred"</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Kernel objects are lightweight descriptors and do not store explicit covariance matrices unless required by a backend.</p>
<p>Precomputed relationship matrices may also be supplied when appropriate, but are not required for most workflows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Optional: precomputed genomic relationship matrix</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>GRM <span class="ot">&lt;-</span> <span class="fu">makeGRMlist</span>(</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">fnGRM    =</span> <span class="st">"grm_inverse.txt"</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">format   =</span> <span class="st">"BINARY"</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">grm_type =</span> <span class="st">"G-inverse"</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="high-dimensional-predictors-feature-matrices" class="level3">
<h3 class="anchored" data-anchor-id="high-dimensional-predictors-feature-matrices">High-dimensional predictors: feature matrices</h3>
<p>Feature matrices define explicit linear predictors with potentially very large numbers of coefficients. Typical examples include genotype matrices, transcriptomic measurements, or other omics data.</p>
<p>Feature data are often stored on disk and accessed lazily by the backend.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Genotype feature matrix (e.g. PLINK BED/BIM/FAM)</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>M <span class="ot">&lt;-</span> <span class="fu">featureMatrix</span>(</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">bedfiles =</span> <span class="st">"chr.bed"</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">bimfiles =</span> <span class="st">"chr.bim"</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">famfiles =</span> <span class="st">"chr.fam"</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Optional feature groupings can be supplied to define multiple variance components or prior structures over subsets of features.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Optional grouping of features</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>featureSets <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">set1 =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">set2 =</span> <span class="dv">1001</span><span class="sc">:</span><span class="dv">2000</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Feature matrices and feature sets are later linked to model components via <em>vc()</em> (REML / solver) or <em>prior()</em> (Bayesian inference).</p>
<section id="bayesian-multi-component-linear-models-with-marker-level-priors" class="level4">
<h4 class="anchored" data-anchor-id="bayesian-multi-component-linear-models-with-marker-level-priors">Bayesian multi-component linear models with marker-level priors</h4>
<p>Marker-level effects differ fundamentally from classical random effects:</p>
<ul>
<li>They typically involve <strong>thousands to millions of coefficients</strong></li>
<li>Covariance is induced <strong>implicitly</strong> through the feature matrix (e.g.&nbsp;genotypes), linkage disequilibrium, and the chosen prior</li>
<li>Explicit covariance matrices (e.g.&nbsp;GRMs) are usually avoided for scalability</li>
</ul>
<p>In <strong>qgtools</strong>, marker effects are treated as <strong>feature-based model components</strong>. They are declared in the model formula as a named effect (e.g.&nbsp;<code>(1 | marker)</code>), and linked to genotype data via a <code>featureMatrix()</code>.</p>
<p>Regularization and covariance structure are then specified through <strong>marker-level priors</strong>, such as <code>bayesC()</code>, optionally using <code>featureSets</code> to define multiple variance components over disjoint (or annotated) subsets of markers.</p>
<p>This approach mirrors how marker effects are handled in software such as BGLR and BayesR, while preserving a clear separation between:</p>
<ul>
<li><strong>model structure</strong> (formulas and named effects),</li>
<li><strong>data representation</strong> (feature matrices and feature sets), and</li>
<li><strong>inference</strong> (Bayesian priors or REML/solver-based estimation).</li>
</ul>
<p>Unlike classical low-dimensional random effects, marker effects are not associated with explicit covariance matrices at the observation level. Instead, their covariance is induced implicitly through the feature matrix and the prior, enabling scalable multi-component and multi-trait models.</p>
</section>
</section>
</section>
<section id="annotated-example-multivariate-mixed-bayesian-genomic-model" class="level2">
<h2 class="anchored" data-anchor-id="annotated-example-multivariate-mixed-bayesian-genomic-model">Annotated example: Multivariate mixed / Bayesian genomic model</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ------------------------------------------------------------------</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Per-trait model formulas</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="do">## ------------------------------------------------------------------</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Formulas declare *which* effects enter the model.</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="do">## 'animal' represents the additive genetic effect (pedigree-based),</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="do">## 'dam' captures a maternal environmental component, and</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 'marker' represents high-dimensional marker effects</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="do">## modeled through a feature matrix.</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>formulas <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">BW =</span> BW <span class="sc">~</span> sex <span class="sc">+</span> reps <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> dam) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> animal) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> marker),</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">Gl =</span> Gl <span class="sc">~</span> sex <span class="sc">+</span> reps <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> dam) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> animal) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> marker)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="do">## ------------------------------------------------------------------</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="do">## Kernel-based effect: pedigree (random effect)</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="do">## ------------------------------------------------------------------</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="do">## Pedigree effects are naturally expressed via kernels.</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>PED <span class="ot">&lt;-</span> <span class="fu">makePEDlist</span>(<span class="at">fnPED =</span> <span class="st">"pedigree.txt"</span>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="do">## ------------------------------------------------------------------</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="do">## Feature-based effect: markers (high-dimensional predictors)</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="do">## ------------------------------------------------------------------</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="do">## Marker effects are defined through a feature matrix</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>M <span class="ot">&lt;-</span> <span class="fu">featureMatrix</span>(</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">bedfiles =</span> <span class="st">"chr.bed"</span>,</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">bimfiles =</span> <span class="st">"chr.bim"</span>,</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">famfiles =</span> <span class="st">"chr.fam"</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="do">## Optional grouping of markers into multiple variance components</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>featureSets <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">set1 =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>,</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">set2 =</span> <span class="dv">1001</span><span class="sc">:</span><span class="dv">2000</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a><span class="do">## ------------------------------------------------------------------</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a><span class="do">## Bayesian prior specification</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a><span class="do">## ------------------------------------------------------------------</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a><span class="do">## Priors replace variance components in Bayesian models.</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a><span class="do">## Each prior corresponds to a named model component.</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>priors <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">dam =</span> <span class="fu">prior</span>(</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">variable     =</span> <span class="st">"dam"</span>,</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">traits       =</span> <span class="fu">c</span>(<span class="st">"BW"</span>, <span class="st">"Gl"</span>),</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">distribution =</span> <span class="fu">iw</span>(<span class="at">df =</span> <span class="dv">4</span>, <span class="at">S =</span> <span class="fu">diag</span>(<span class="dv">1</span>, <span class="dv">2</span>)),</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">start        =</span> <span class="fu">diag</span>(<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>  <span class="at">animal =</span> <span class="fu">prior</span>(</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">variable     =</span> <span class="st">"animal"</span>,</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">traits       =</span> <span class="fu">c</span>(<span class="st">"BW"</span>, <span class="st">"Gl"</span>),</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">kernel       =</span> PED,</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">distribution =</span> <span class="fu">iw</span>(<span class="at">df =</span> <span class="dv">4</span>, <span class="at">S =</span> <span class="fu">diag</span>(<span class="dv">1</span>, <span class="dv">2</span>)),</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">start        =</span> <span class="fu">diag</span>(<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>  <span class="at">marker =</span> <span class="fu">prior</span>(</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">variable     =</span> <span class="st">"marker"</span>,</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">traits       =</span> <span class="fu">c</span>(<span class="st">"BW"</span>, <span class="st">"Gl"</span>),</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">features     =</span> M,</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">featureSets  =</span> featureSets,</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">distribution =</span> <span class="fu">bayesC</span>(</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>      <span class="at">pi     =</span> <span class="fu">beta</span>(<span class="dv">95</span>, <span class="dv">5</span>),</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>      <span class="at">sigma2 =</span> <span class="fu">invchisq</span>(<span class="at">df =</span> <span class="dv">4</span>, <span class="at">scale =</span> <span class="fl">0.001</span>),</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>      <span class="at">start  =</span> <span class="fu">list</span>(</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>        <span class="at">set1 =</span> <span class="fu">diag</span>(<span class="fl">0.005</span>, <span class="dv">2</span>),</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>        <span class="at">set2 =</span> <span class="fu">diag</span>(<span class="fl">0.001</span>, <span class="dv">2</span>)</span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>  <span class="at">residual =</span> <span class="fu">prior</span>(</span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">variable     =</span> <span class="st">"residual"</span>,</span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">traits       =</span> <span class="fu">c</span>(<span class="st">"BW"</span>, <span class="st">"Gl"</span>),</span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">distribution =</span> <span class="fu">iw</span>(<span class="at">df =</span> <span class="dv">4</span>, <span class="at">S =</span> <span class="fu">diag</span>(<span class="dv">1</span>, <span class="dv">2</span>)),</span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">start        =</span> <span class="fu">diag</span>(<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a><span class="do">## ------------------------------------------------------------------</span></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a><span class="do">## Model fitting</span></span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a><span class="do">## ------------------------------------------------------------------</span></span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a><span class="do">## The estimation task determines how the model is fit,</span></span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a><span class="do">## without changing the model structure.</span></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>fit_bayes <span class="ot">&lt;-</span> <span class="fu">gfit</span>(</span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>  <span class="at">formulas =</span> formulas,</span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>  <span class="at">data     =</span> data,</span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>  <span class="at">priors   =</span> priors,</span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>  <span class="at">task     =</span> <span class="st">"bayes"</span></span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The same model specification can be estimated using a marker BLUP formulation by replacing <code>prior()</code> with <code>vc()</code> and setting <code>task = "solve"</code>. The formulas, kernels, and feature matrices remain unchanged.</p>
<p>Additional worked examples for REML/solve and Bayesian mixed models (single- and multi-trait) are provided in the vignettes.</p>
</section>
<section id="classical-quantitative-genetics-case-studies-dmu-examples" class="level2">
<h2 class="anchored" data-anchor-id="classical-quantitative-genetics-case-studies-dmu-examples">Classical quantitative genetics case studies (DMU examples)</h2>
<p>qgtools is designed to express a wide range of classical quantitative genetic models while cleanly separating model structure from estimation strategy.</p>
<p>To demonstrate compatibility with established workflows, several standard examples from <strong>DMU</strong> are reproduced below using qgtools. In each case, the <em>same model specification</em> can be estimated using REML, solver-based BLUP, or Bayesian inference by changing only the estimation task.</p>
<section id="dmu-based-examples" class="level3">
<h3 class="anchored" data-anchor-id="dmu-based-examples">DMU-based examples</h3>
<ul>
<li><p><strong>Genotype × feeding system interaction</strong><br>
Multi-trait model with unrelated sires and G×E expressed through cross-trait covariance.<br>
<a href="https://psoerensen.github.io/qgtools/examples/dmu_examples/dmu_example_1.html">View example →</a></p></li>
<li><p><strong>Direct and maternal genetic effects in sheep growth</strong><br>
Multi-trait pedigree model with direct genetic, maternal genetic, and environmental effects.<br>
<a href="https://psoerensen.github.io/qgtools/examples/dmu_examples/dmu_example_2.html">View example →</a></p></li>
<li><p><strong>Random regression model for growth hormone profiles</strong><br>
Longitudinal random regression model with permanent environmental and additive genetic effects using Legendre polynomials.<br>
<a href="https://psoerensen.github.io/qgtools/examples/dmu_examples/dmu_example_rr.html">View example →</a></p></li>
</ul>
<p>These examples illustrate how complex legacy DMU models translate directly into qgtools while benefiting from a clearer and more modular model specification.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>