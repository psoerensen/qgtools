---
title: "qgtools"
output: github_document
---

## Overview

**qgtools** is a framework for specifying and fitting mixed and hierarchical models, with a focus on quantitative genetics and complex covariance structures.

The key idea behind qgtools is to **separate model specification from model fitting**, allowing the same model to be estimated using different software backends and estimation paradigms within a unified modeling framework.


## Core ideas

- **Formulas define model structure**  
  Per-trait formulas specify responses, fixed effects, and random effects, but not how covariance is modeled.

- **Variance components define covariance**  
  Variance components describe how random effects induce covariance across individuals and traits, using kernels and optional priors.

- **Kernels are reusable objects**  
  Pedigree, genomic, and other kernels are standalone objects that can be reused across models and fitting tasks.

- **Tasks control estimation**  
  Models are fitted using `gfit()` with `task = "reml"`, `"bayes"`, or `"solve"`, without changing the model specification.

- **Scalable data access**  
  Data are treated as a data source, allowing both in-memory and disk-backed datasets to be used transparently.

**qgtools** handles large-scale data by taking advantage of:  
  
* multi-core processing using [openMP](https://www.openmp.org/)  
* multithreaded matrix operations implemented in BLAS libraries (e.g. [OpenBLAS](https://www.openblas.net/), [ATLAS](https://math-atlas.sourceforge.net/) or [MKL](https://en.wikipedia.org/wiki/Math_Kernel_Library))  
* fast and memory-efficient batch processing of genotype data stored in binary files (e.g. [PLINK](https://www.cog-genomics.org/plink2) bedfiles)  


## Example

```{r, eval = FALSE}

## Example

```{r, eval = FALSE}

## Prepare data source (can be an in-memory data frame or a disk-backed file)
data <- "data.txt"

## Prepare pedigree kernel for additive genetic effects
PED <- makePEDlist(fnPED = "pedigree.txt")

## ---- Single-trait animal model --------------------------------------------

## Model formula:
## (1 | id) represents the additive genetic (animal) effect
formulas <- list(
  BW = BW ~ sex + reps + (1 | dam) + (1 | id)
)

## Variance components define how covariance is modeled
vcs <- list(
  dam_env = vc(index = "dam", traits = "BW"),          # dam environmental effect
  animal_genetic = vc(index = "id", traits = "BW",
                       kernel = PED),                  # additive genetic effect
  residual = vc(index = "Residual", traits = "BW")    # residual variance
)

## Fit the single trait model and estimate variance component using REML
fit <- gfit(formulas, data, vcs, task = "reml")

##  Multi-trait animal model 

## Same model structure, now for two correlated traits
formulas_mt <- list(
  Gl = Gl ~ sex + reps + (1 | dam) + (1 | id),
  BW = BW ~ sex + reps + (1 | dam) + (1 | id)
)

## Shared variance components induce correlation between traits
vcs_mt <- list(
  dam_env = vc(index = "dam", traits = c("Gl", "BW")),
  animal_genetic = vc(index = "id", traits = c("Gl", "BW"),
                       kernel = PED),
  residual = vc(index = "Residual", traits = c("Gl", "BW"))
)

## Fit the multiple trait model and estimate variance component using REML
fit_mt <- gfit(formulas_mt, data, vcs_mt, task = "reml")

```

